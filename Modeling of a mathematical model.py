import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import solve_ivp

# Константы планеты
M = 1.224398e23  # Масса планеты (Ева), кг
G = 6.67 * 10 ** -11  # Гравитационная постоянная, м^3/(кг·с^2)
R = 700000  # Радиус планеты, м
Mu = 8.1717302 * 10 ** 12  # Гравитационный параметр, м^3/с^2

# Атмосферные параметры
P0 = 506625  # Давление у поверхности, Па
H = 7921  # Высота масштабирования атмосферы, м
T = 380  # Температура атмосферы, К
R_specific = 287.052874  # Удельная газовая постоянная, Дж/(кг·К)

# Параметры аппарата
m = 6950  # Масса аппарата, кг
A = 4.8  # Площадь поперечного сечения, м^2
Cd = 1.2  # Коэффициент аэродинамического сопротивления

# Функции для вычисления сил
def g(h):
    """Гравитационное ускорение в зависимости от высоты."""
    h = max(h, 1e-3)  # Избегаем деления на ноль
    return G * M / (R + h)**2

def pressure(h):
    """Давление в зависимости от высоты."""
    return P0 * np.exp(-h / H)

def rho(h):
    """Плотность атмосферы в зависимости от высоты."""
    return pressure(h) / (R_specific * T)

def drag_force(V, h):
    Cd = 0.015
    A = 4.5
    if h <= 5000:
        Cd = 0.5
        A = 125
    elif h <= 4000:
        Cd = 0.55
        A = 50
    elif h <= 3000:
        Cd = 0.75
        A = 33 + 50
    elif h <= 1500:
        Cd = 0.8
        A = 32 * 3 + 33
    """Сила аэродинамического сопротивления."""
    return 0.5 * Cd * A * rho(h) * V**2

def equations(t, state):
    """Уравнения движения аппарата."""
    x, y, z, Vx, Vy, Vz = state
    r = np.sqrt(x**2 + y**2 + z**2)

    # Текущая высота и скорость
    h = max(r - R, 0)  # Высота над поверхностью (не может быть отрицательной)
    V = np.sqrt(Vx**2 + Vy**2 + Vz**2)  # Полная скорость

    # Силы
    Fg = g(h) * m  # Сила тяжести
    Fd = drag_force(V, h)  # Сила сопротивления

    # Компоненты ускорений
    ax = (-Mu / (r ** 3)) * x - (Fd * Vx) / m
    ay = (-Mu / (r ** 3)) * y - (Fd * Vy) / m
    az = (-Mu / (r ** 3)) * z - (Fd * Vz) / m

    # Дифференциальные уравнения
    dx_dt = Vx
    dy_dt = Vy
    dz_dt = Vz

    dVx_dt = ax
    dVy_dt = ay
    dVz_dt = az

    return [dx_dt, dy_dt, dz_dt, dVx_dt, dVy_dt, dVz_dt]

# Начальные условия
x0, y0, z0 = -275881.3816859111, -8576.813349455595, 734451.7981707016  # Положение
r0 = np.sqrt(x0**2 + y0**2 + z0**2)
h0 = max(r0 - R, 0)  # Убедиться, что начальная высота не отрицательная
Vx0, Vy0, Vz0 = -3069.52036166164, 131.86202009816031, -1434.9684166742516  # Скорости
state0 = [x0, y0, z0, Vx0, Vy0, Vz0]

# Время моделирования
t_span = (0, 727)
t_eval = np.linspace(*t_span, 6270)

# Численное решение
solution = solve_ivp(equations, t_span, state0, t_eval=t_eval, max_step=1)

# Результаты
x, y, z = solution.y[0], solution.y[1], solution.y[2]
Vx, Vy, Vz = solution.y[3], solution.y[4], solution.y[5]
V = np.sqrt(Vx**2 + Vy**2 + Vz**2)
r = np.sqrt(x**2 + y**2 + z**2)
h = r - R
t = solution.t

# Плотность атмосферы
rho_vals = rho(h)
Pressure = pressure(h)

# Функция для построения графиков
def F(n1, n2, n3, lst_x, lst_y, t_x, t_y, color, name_graf):
    plt.subplot(n1, n2, n3)
    plt.plot(lst_x, lst_y, color=color)
    plt.xlabel(t_x)
    plt.ylabel(t_y)
    plt.grid()
    plt.title(name_graf)  # Подпись графика

def graf_3D(position_x, position_y, position_z):
    # 3D график для траектории
    fig = plt.figure(figsize=(7, 4))
    ax_3d = fig.add_subplot(111, projection='3d')
    ax_3d.scatter(position_x, position_y, position_z, color='blue')
    ax_3d.set_xlabel('X')
    ax_3d.set_ylabel('Y')
    ax_3d.set_zlabel('Z')
    ax_3d.set_title('Траектория спуска')
    ax_3d.grid(True)
    ax_3d.view_init(elev=30, azim=30) 

# Создание графиков
plt.figure(figsize=(10, 8))  # Окно для графиков скоростей
F(2, 2, 1, t, Vx, "Время (с)", "Скорость по X (м/с)", '#3c88bd', "Скорость по X от времени")
F(2, 2, 2, t, Vy, "Время (с)", "Скорость по Y (м/с)", '#ff7f0e', "Скорость по Y от времени")
F(2, 2, 3, t, Vz, "Время (с)", "Скорость по Z (м/с)", '#2ca02c', "Скорость по Z от времени")
F(2, 2, 4, t, V, "Время (с)", "Общая скорость (м/с)", 'red', "Общая скорость от времени")

plt.figure(figsize=(10, 8))  # Окно для графиков координат
F(2, 2, 1, t, x, "Время (с)", "Координаты по X (м)", '#3c88bd', "Координаты по X от времени")
F(2, 2, 2, t, y, "Время (с)", "Координаты по Y (м)", '#ff7f0e', "Координаты по Y от времени")
F(2, 2, 3, t, z, "Время (с)", "Координаты по Z (м)", '#2ca02c', "Координаты по Z от времени")

plt.figure(figsize=(10, 8))  # Окно для траектории
F(2, 2, 1, x, y, "Координата по X (м)", "Координата по Y (м)", 'blue', "Траектория X-Y")
F(2, 2, 2, y, z, "Координата по Y (м)", "Координата по Z (м)", 'red', "Траектория Y-Z")
F(2, 2, 3, z, x, "Координата по Z (м)", "Координата по X (м)", 'green', "Траектория Z-X")

plt.figure(figsize=(10, 8))  # Окно для графиков высоты
F(2, 2, 1, t, h, "Время (с)", "Высота (м)", 'green', "Высота от времени")
F(2, 2, 2, V, h, "Скорость (м/с)", "Высота (м)", 'green', "Высота от скорости")
plt.gca().invert_xaxis()
F(2, 2, 3, h, rho_vals, "Высота (м)", "Плотность (кг/м³)", 'purple', "Плотность атмосферы от высоты")
F(2, 2, 4, h, Pressure / 10 ** 5, "Высота (м)", "Давление (Па)", 'purple', "Давление от высоты")

graf_3D(x, y, z)

plt.show()